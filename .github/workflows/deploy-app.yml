name: ðŸš€ Deploy

on:
  workflow_run:
    workflows: ["ðŸ³ Build Docker Image", "ðŸ”’ Container Security Scan"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image:
        description: 'Docker image to deploy (leave empty for latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'success' && 
       (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: 
      name: staging
      url: https://staging.yourapp.com
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Determine image to deploy
        id: image
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.image }}" ]; then
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
          else
            echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Deploy to staging
        run: |
          echo "ðŸš€ Deploying ${{ steps.image.outputs.image }} to staging..."
          # Add your staging deployment logic here
          # Examples:
          # - kubectl apply -f k8s/staging/
          # - docker-compose -f docker-compose.staging.yml up -d
          # - ansible-playbook deploy-staging.yml
          # - aws ecs update-service --cluster staging --service nestjs-app --force-new-deployment
          echo "âœ… Staging deployment completed"

      - name: ðŸ§ª Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests against staging..."
          # Add smoke tests here
          # curl -f https://staging.yourapp.com/health || exit 1
          # npm run test:smoke:staging
          echo "âœ… Smoke tests passed"

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://staging.yourapp.com" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: |
      startsWith(github.ref, 'refs/tags/v') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: 
      name: production
      url: https://yourapp.com
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Determine image to deploy
        id: image
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.image }}" ]; then
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
          else
            echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŒŸ Deploy to production
        run: |
          echo "ðŸŒŸ Deploying ${{ steps.image.outputs.image }} to production..."
          # Add your production deployment logic here
          echo "âœ… Production deployment completed"

      - name: ðŸ§ª Run production smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests against production..."
          # Add production smoke tests here
          echo "âœ… Production smoke tests passed"

      - name: ðŸ“¢ Notify deployment
        run: |
          echo "ðŸ“¢ Notifying team about production deployment..."
          # Add notification logic (Slack, email, etc.)

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸŒŸ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://yourapp.com" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY